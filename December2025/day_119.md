
    # ---------- CHECK LINE COUNT ----------
    if len(input_grid) % 4 != 0:
        raise ValueError("Number of input lines is not a multiple of four")

    # ---------- CHECK COLUMN COUNT ----------
    line_length = len(input_grid[0])
    if line_length % 3 != 0:
        raise ValueError("Number of input columns is not a multiple of three")

    # ---------- PROCESS MULTIPLE BLOCKS ----------
    result = []
    total_rows = len(input_grid)

    # For every block of 4 rows
    row = 0
    while row < total_rows:
        block_rows = input_grid[row:row+4]
        result.append(process_row_block(block_rows, numbers))
        row += 4

    return ",".join(result)


def process_row_block(block_rows, numbers):
    """Convert a 4-row block into digits."""
    num_digits = len(block_rows[0]) // 3
    output = ""

    col = 0
    while col < num_digits:
        # Extract the 3-column-wide digit
        digit_pattern = []
        i = 0
        while i < 4:
            start = col * 3
            end = start + 3
            digit_pattern.append(block_rows[i][start:end])
            i += 1

        # Compare to known numbers
        found = False
        for key, pattern in numbers.items():
            if pattern == digit_pattern:
                output += key
                found = True
                break

        if not found:
            output += "?"

        col += 1

    return output
